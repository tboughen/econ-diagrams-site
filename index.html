<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Microeconomics - Supply and Demand</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; user-select:none; display:flex; flex-direction:column; height:100vh; }
    nav { background:#333; color:#fff; padding:10px; text-align:center; }
    #main-container { flex:1; display:flex; overflow:hidden; }
    #sidebar {
      width:200px; background:#f5f5f5; border-right:1px solid #ccc;
      padding:20px; box-sizing:border-box; display:flex; flex-direction:column; gap:20px;
    }
    #sidebar h2 { margin:0; font-size:16px; text-align:center; }

    #buttonRow, #actionsRow { display:flex; flex-direction:row; justify-content:space-between; align-items:center; }
    #buttonRow button, #actionsRow button {
      flex:1; margin:0 5px; padding:10px 15px; font-size:16px; cursor:pointer;
      background:#ddd; color:#000; border:1px solid #999; border-radius:4px; transition:background-color .2s;
    }
    #buttonRow button:hover, #actionsRow button:hover { background:#ccc; }
    #buttonRow button:active, #actionsRow button:active { background:#bbb; }

    #marginToggle {
      text-align:center; padding:10px 0; cursor:pointer; background:#ddd; color:#000;
      border:1px solid #999; border-radius:4px; transition:background-color .2s; user-select:none;
    }
    #marginToggle:hover { background:#ccc; } #marginToggle:active { background:#bbb; } #marginToggle.active { background:#FFC300; }

    #curveToggle, #equilibriumToggle { display:flex; border:1px solid #999; border-radius:4px; overflow:hidden; }
    .curve-control-segment {
      flex:1; text-align:center; padding:10px 0; cursor:pointer; background:#ddd; color:#000; user-select:none; transition:background-color .2s;
    }
    .curve-control-segment:not(.active):hover { background:#ccc; }
    .curve-control-segment:not(.active):active { background:#bbb; }
    .curve-control-segment.active { background:#FFC300; }
    .curve-control-segment:not(:last-child) { border-right:1px solid #999; }

    .curve-row { display:flex; width:100%; gap:10px; box-sizing:border-box; }
    .curve-row button {
      flex:1 1 0; min-width:0; margin:0; padding:10px 15px; font-size:16px; cursor:pointer;
      background:#ddd; color:#000; border:1px solid #999; border-radius:4px; transition:background-color .2s; box-sizing:border-box;
    }
    .curve-row button:hover { background:#ccc; }
    .curve-row button:active { background:#bbb; }
    .curve-row button.active { background:#FFC300; }
    #curveButtons button.active, #demandButtons button.active { background:#FFC300; }

    .curve-row button .sub { font-size:.70em; vertical-align:-.20em; margin-left:0; }

    #canvas-area { flex:1; display:flex; flex-direction:column; margin:20px; gap:10px; }
    #canvas-container { display:flex; justify-content:center; align-items:center; }
    canvas { border:1px solid #ccc; }
  </style>
</head>
<body>
  <nav><h1>Microeconomics - Supply and Demand</h1></nav>

  <div id="main-container">
    <div id="sidebar">
      <h2>Diagram Tools</h2>
      <div id="buttonRow">
        <button id="btnLarger" title="Increase text/line size">+</button>
        <button id="btnReset" title="Reset text/line size">⟲</button>
        <button id="btnSmaller" title="Decrease text/line size">–</button>
      </div>
      <div id="marginToggle" title="Toggle inner margins">Margin</div>

      <h2>History & Reset</h2>
      <div id="actionsRow">
        <button id="btnUndo" title="Undo">↶</button>
        <button id="btnRedo" title="Redo">↷</button>
        <button id="btnResetActions" title="Reset curves & price">⟲</button>
      </div>

      <h2>Curve Control</h2>
      <div id="curveToggle">
        <div id="toggleShifts" class="curve-control-segment active">Shifts</div>
        <div id="toggleElasticity" class="curve-control-segment">Elasticity</div>
      </div>

      <!-- Demand ABOVE Supply, identical widths -->
      <div id="demandButtons" class="curve-row">
        <button id="btnD1" aria-label="D 1">D<span class="sub">1</span></button>
        <button id="btnD2" aria-label="D 2">D<span class="sub">2</span></button>
        <button id="btnD3" aria-label="D 3">D<span class="sub">3</span></button>
      </div>
      <div id="curveButtons" class="curve-row">
        <button id="btnS1" aria-label="S 1">S<span class="sub">1</span></button>
        <button id="btnS2" aria-label="S 2">S<span class="sub">2</span></button>
        <button id="btnS3" aria-label="S 3">S<span class="sub">3</span></button>
      </div>

      <h2>Equilibrium Control</h2>
      <div id="equilibriumToggle">
        <div id="toggleEquilibrium" class="curve-control-segment active">Equilibrium</div>
        <div id="toggleDisequilibrium" class="curve-control-segment">Disequilibrium</div>
      </div>
    </div>

    <div id="canvas-area">
      <div id="canvas-container">
        <!-- Square canvas with gutters (left/bottom) -->
        <canvas id="diagram" width="700" height="700"></canvas>
      </div>
    </div>
  </div>

   <script type="module">
    import { clamp, isPointWithinBoundaries, getLineSegmentWithinBounds, computeIntersection } from './src/core/geometry.js';
    import { splitBaseSub } from './src/core/labels.js';
    import { computeBraceRadii, planUnderbrace4QuartersAnchored } from './src/core/brace.js';
  
    // ↓↓↓ Paste your existing script’s content below,
    // but remove the old definitions of:
    //   clamp, isPointWithinBoundaries, getLineSegmentWithinBounds,
    //   computeIntersection, normalizeSubDigits, splitBaseSub,
    //   computeBraceRadii, strokeLeftEndCurlHalfFromJoin,
    //   strokeRightEndCurlHalfFromJoin, drawUnderbrace4QuartersAnchored
    //
    // And update any references:
    //  - use the imported clamp/getLineSegmentWithinBounds/computeIntersection directly
    //  - instead of drawUnderbrace4QuartersAnchored(...), do:
    //        const plan = planUnderbrace4QuartersAnchored(...);
    //        if (plan) executeBracePlan(ctx, plan);   // helper provided below
    //
    //  - keep drawWithSubscript as-is (it draws to canvas); we only moved parsing.
  
    // --- helper to execute a brace plan from core/brace.js ---
    function executeBracePlan(ctx, plan) {
      const { style, ops } = plan;
      ctx.save();
      ctx.setLineDash([]);
      ctx.strokeStyle = style.color;
      ctx.lineWidth = style.lineWidth;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
  
      for (const op of ops) {
        if (op.op === 'line') {
          ctx.beginPath();
          ctx.moveTo(op.from.x, op.from.y);
          ctx.lineTo(op.to.x, op.to.y);
          ctx.stroke();
        } else if (op.op === 'quad') {
          ctx.beginPath();
          ctx.moveTo(op.from.x, op.from.y);
          ctx.quadraticCurveTo(op.ctrl.x, op.ctrl.y, op.to.x, op.to.y);
          ctx.stroke();
        } else if (op.op === 'arc') {
          ctx.beginPath();
          ctx.arc(op.cx, op.cy, op.r, op.fromAngle, op.toAngle, op.ccw);
          ctx.stroke();
        }
      }
      ctx.restore();
    }
  
    // === paste the REST of your existing code here ===
  </script>

</body>
</html>

